<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>영단어 암기 MVP</title>
  <style>
    :root { --gap: 12px; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0c0f; color:#e5e7eb; }
    header { padding: 16px 20px; border-bottom: 1px solid #1f2937; position: sticky; top: 0; background: #0b0c0f; z-index: 10; }
    main { padding: 20px; max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 420px 1fr; gap: var(--gap); }
    h1 { margin: 0; font-size: 18px; font-weight: 600; letter-spacing: .2px; }
    .card { border: 1px solid #1f2937; background: #0f1115; border-radius: 14px; padding: 14px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .field { display: grid; gap: 6px; margin-bottom: 10px; }
    label { font-size: 12px; color: #9ca3af; }
    input, textarea, select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #273244; background:#0b0e12; color:#e5e7eb; outline: none; }
    input:focus, textarea:focus { border-color:#3b82f6; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #273244; background:#10131a; color:#e5e7eb; cursor: pointer; }
    button:hover { background:#0d1117; }
    button.primary { background:#1f2a44; border-color:#314064; }
    button.primary:hover { background:#223054; }
    .muted { color:#9ca3af; font-size: 12px; }
    .list { display: grid; gap: 8px; max-height: 360px; overflow:auto; padding-right:6px; }
    .item { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; border:1px solid #1f2937; border-radius:12px; padding:10px 12px; background:#0b0e12; }
    .tag { font-size: 11px; color:#9ca3af; }
    .actions { display:flex; gap:8px; }

    @media (max-width: 880px) { main { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>영단어 암기 MVP</h1>
  </header>

  <main>
    <!-- 왼쪽: 입력/목록 -->
    <section class="card">
      <h2 style="margin:2px 0 12px 2px; font-size:15px;">단어 추가</h2>
      <div class="field">
        <label for="w">영어 단어</label>
        <input id="w" placeholder="예: imperative" />
      </div>
      <div class="field">
        <label for="m">뜻 (쉼표로 구분)</label>
        <input id="m" placeholder="필수의, 명령의" />
      </div>
      <div class="row">
        <div class="actions">
          <button id="add" class="primary">단어 추가</button>
          <button id="clearInput">입력 지움</button>
        </div>
        <small id="msg" class="muted"></small>
      </div>

      <hr style="border:none; border-top:1px solid #1f2937; margin:14px 0;" />

      <div class="row">
        <div class="actions" style="flex-wrap:wrap">
          <button id="pullServer">서버에서 불러오기(갱신)</button>
          <button id="exportServer">서버로 업로드(덮어쓰기)</button>
          <button id="resetAll" title="모든 단어 삭제">전체 초기화</button>
        </div>
        <div class="muted">서버 JSON과 동기화: 불러오기는 서버→로컬, 업로드는 로컬→서버</div>
      </div>

      <hr style="border:none; border-top:1px solid #1f2937; margin:14px 0;" />

      <h2 style="margin:2px 0 8px 2px; font-size:15px;">내 단어 (<span id="count">0</span>)</h2>
      <div id="list" class="list"></div>
    </section>

    <!-- 오른쪽: 학습 -->
    <section class="card">
      <div class="row">
        <h2 style="margin:2px 0 8px 2px; font-size:15px;">학습</h2>
        <div class="muted" id="stats">오늘 0개 · 정답률 0%</div>
      </div>

      <div class="quiz">
        <div class="panel" id="panel">
          <div class="word" id="q">단어를 불러오세요</div>
          <div class="meaning" id="a" style="display:none"></div>
        </div>

        <div class="row">
          <input id="ans" placeholder="한글 뜻 입력" />
          <div class="actions">
            <button id="submit" class="primary">제출</button>
            <button id="next">다음</button>
          </div>
        </div>
        <div class="row">
          <div class="actions">
            <button id="know">암기완료(삭제)</button>
            <button id="show">보기/숨기기</button>
            <button id="load">단어 랜덤 불러오기</button>
          </div>
          <div class="naver" id="naver"></div>
        </div>
        <div id="result" class="result muted"></div>
      </div>
    </section>
  </main>

  <script>
  // ====== 상수 ======
  const LS_KEY = 'vocab_list';                 // [{ word, meaning:[] }]
  const API_PUBLISH = 'https://vocab-updater.vercel.app/api/publish';

  // ====== 공통 유틸 ======
  const norm = (s) => (s || '').trim().toLowerCase();
  const normalizeWord = (s) => (s||'').trim();
  const parseMeanings = (s) => (s||'').split(',').map(x=>x.trim()).filter(Boolean);
  const escapeHtml = (s) => String(s).replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  // ====== 상태 ======
  let vocab = [];       // [{word, meaning:[]}]
  let current = null;   // 현재 {word, meaning:[]}

  // ====== DOM ======
  const el = (id) => document.getElementById(id);
  const w = el('w'), m = el('m'), msg = el('msg');
  const listEl = el('list'), countEl = el('count');
  const q = el('q'), a = el('a'), ans = el('ans');
  const result = el('result'), stats = el('stats'), naver = el('naver');

  // ====== 로컬 저장/로드 ======
  const loadVocab = () => {
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
    catch { return []; }
  };
  const saveVocab = (list) => localStorage.setItem(LS_KEY, JSON.stringify(list));

  // ====== 목록 렌더 ======
  const hasWord = (word) => vocab.some(x => norm(x.word) === norm(word));
  const dedupeListKeepFirst = (items) => {
    const seen = new Set(); const out = [];
    for (const it of items || []) {
      const key = norm(it.word); if (!key || seen.has(key)) continue;
      seen.add(key);
      const meaning = Array.isArray(it.meaning) ? it.meaning
        : (it.meaning ? [String(it.meaning)] : []);
      out.push({ word: it.word, meaning: meaning.map(s => String(s).trim()).filter(Boolean) });
    }
    return out;
  };

  const updateList = () => {
    countEl.textContent = String(vocab.length);
    listEl.innerHTML = '';
    if (vocab.length === 0) {
      listEl.innerHTML = '<div class="muted">단어가 없습니다. 왼쪽에서 추가하세요.</div>';
      return;
    }
    for (const item of vocab) {
      const row = document.createElement('div');
      row.className = 'item';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:600">${escapeHtml(item.word)}</div>` +
                       `<div class="tag">${escapeHtml(item.meaning.join(', '))}</div>`;
      const right = document.createElement('div');
      right.className = 'actions';
      const del = document.createElement('button');
      del.textContent = '삭제';
      del.onclick = () => deleteWord(item.word);
      right.appendChild(del);
      row.appendChild(left); row.appendChild(right);
      listEl.appendChild(row);
    }
  };

  // ====== 통계 ======
  const STATS_KEY = () => 'stats_' + new Date().toISOString().slice(0,10);
  const loadStats = () => {
    try { return JSON.parse(localStorage.getItem(STATS_KEY())) || { tried:0, correct:0 }; }
    catch { return { tried:0, correct:0 }; }
  };
  const saveStats = (s) => localStorage.setItem(STATS_KEY(), JSON.stringify(s));
  const renderStats = () => {
    const s = loadStats();
    const rate = s.tried ? Math.round((s.correct/s.tried)*100) : 0;
    stats.textContent = `오늘 ${s.tried}개 · 정답률 ${rate}%`;
  };

  // ====== 학습 흐름 ======
  const makeNaverLink = (word) => {
    if (!word) { naver.innerHTML = ''; return; }
    const q = encodeURIComponent(word);
    naver.innerHTML = `<a href="https://en.dict.naver.com/#/search?query=${q}" target="_blank" rel="noopener">네이버사전에서 보기 ↗</a>`;
  };
  const setQuestion = (item) => {
    current = item;
    q.textContent = item ? item.word : '모든 단어를 외웠습니다!';
    a.textContent = item ? item.meaning.join(', ') : '';
    a.style.display = 'none';
    result.textContent = '';
    ans.value = '';
    makeNaverLink(item?.word || '');
    ans.focus();
  };
  const showAnswer = (show) => { a.style.display = show ? 'block' : 'none'; };
  const pickRandom = () => (vocab.length ? vocab[Math.floor(Math.random()*vocab.length)] : null);

  const check = () => {
    if (!current) { result.textContent = '단어를 먼저 불러오세요.'; return; }
    const user = ans.value.trim();
    if (!user) { result.textContent = '답을 입력하세요.'; return; }
    const ok = current.meaning.some(m => m && user.includes(m));
    const s = loadStats(); s.tried += 1; if (ok) s.correct += 1; saveStats(s); renderStats();
    result.textContent = ok ? '정답!' : `오답! 정답: ${current.meaning.join(', ')}`;
    showAnswer(true);
  };
  const next = () => setQuestion(pickRandom());
  const deleteWord = (word) => {
    const k = norm(word);
    vocab = vocab.filter(x => norm(x.word) !== k);
    saveVocab(vocab); updateList(); alert(`'${word}' 단어가 삭제되었습니다.`);
  };
  const knowIt = () => { if (!current) return; deleteWord(current.word); setQuestion(pickRandom()); };

  // ====== 버튼 이벤트(입력 영역) ======
  el('add').onclick = () => {
    const word = normalizeWord(w.value);
    const meanings = parseMeanings(m.value);
    if (!word || meanings.length === 0) { msg.textContent = '단어와 뜻을 모두 입력하세요.'; return; }
    if (hasWord(word)) { msg.textContent = `이미 존재: '${word}' (영어 기준 중복 차단)`; w.value=''; m.value=''; w.focus(); return; }
    vocab.push({ word, meaning: meanings }); saveVocab(vocab); updateList();
    msg.textContent = `추가됨: ${word}`; w.value=''; m.value=''; w.focus();
  };
  el('clearInput').onclick = () => { w.value=''; m.value=''; w.focus(); msg.textContent=''; };
  el('submit').onclick = check;
  el('next').onclick   = next;
  el('show').onclick   = () => showAnswer(a.style.display==='none');
  el('load').onclick   = () => setQuestion(pickRandom());
  el('know').onclick   = knowIt;

  // ====== 서버에서 불러오기(PULL: 서버→로컬 덮어쓰기) ======
  async function pullServer() {
    try {
      // 로컬 변경사항이 날아갈 수 있음 → 경고
      if (vocab.length && !confirm('서버의 내용으로 이 기기의 목록을 덮어쓸까요? (로컬 미반영 수정은 사라질 수 있어요)')) return;

      const res = await fetch('vocab_list.json?ts=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);

      let remote = await res.json();
      remote = Array.isArray(remote) ? dedupeListKeepFirst(remote) : [];

      vocab = remote;
      saveVocab(vocab);
      updateList(); setQuestion(pickRandom());
      alert('서버에서 최신 목록을 불러왔습니다. (' + vocab.length + '개)');
    } catch (e) {
      console.warn('[pull] 실패:', e);
      alert('서버에서 불러오기에 실패했습니다: ' + e.message);
    }
  }
  el('pullServer').onclick = pullServer;

  // ====== 서버로 업로드(PUSH: 로컬→서버 덮어쓰기) ======
  el('exportServer').onclick = async () => {
    const btn = el('exportServer');
    btn.disabled = true; const old = btn.textContent; btn.textContent = '서버 반영 중...';
    try {
      if ((vocab?.length || 0) < 3) {
        const ok = confirm('단어가 3개 미만입니다. 정말 서버 JSON을 덮어쓸까요?');
        if (!ok) return;
      }
      const payload = { data: dedupeListKeepFirst(vocab), message: `Update from UI ${new Date().toISOString()}` };
      const r = await fetch(API_PUBLISH, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        cache: 'no-store'
      });
      const text = await r.text();
      let j; try { j = JSON.parse(text); } catch {}
      if (!r.ok) throw new Error(`${r.status} ${r.statusText} — ${j?.message || text}`);
      alert('서버 반영 완료! commit: ' + (j?.commit || 'ok'));
    } catch (e) {
      alert('업로드 실패: ' + e.message);
    } finally {
      btn.disabled = false; btn.textContent = old;
    }
  };

  // ====== 전체 초기화(이 기기만) ======
  el('resetAll').onclick = () => {
    if (!confirm('모든 단어를 삭제할까요? (이 기기 LocalStorage만 초기화)')) return;
    vocab = []; saveVocab(vocab); updateList(); setQuestion(null);
  };

  // ====== 초기화: 로컬 → 없으면 서버 시드(최초 1회), 그리고 렌더 ======
  async function init() {
    vocab = loadVocab();
    if (!vocab || vocab.length === 0) {
      try {
        const res = await fetch('vocab_list.json?ts=' + Date.now(), { cache: 'no-store' });
        if (res.ok) {
          let data = await res.json();
          vocab = dedupeListKeepFirst(data);
          saveVocab(vocab);
        }
      } catch (e) {
        console.warn('초기 시드 실패:', e);
        vocab = [];
      }
    }
    updateList(); renderStats(); setQuestion(pickRandom());
  }

  init();
  </script>
</body>
</html>
